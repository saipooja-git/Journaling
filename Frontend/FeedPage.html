<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Diary – Feed</title>

  <link rel="stylesheet" href="./FeedPage.css" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
    crossorigin="anonymous"
  />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .Post { border-radius: 1rem; }
    .viewPostButton { background: #111; }
  </style>
</head>

<body>
  <div class="text-end p-2 d-flex gap-2 justify-content-end">
    <a href="/Frontend/Post.html" class="btn btn-primary">New Post</a>
    <a href="/Frontend/Login.html" class="btn btn-danger" id="logoutBtn">Logout</a>
  </div>

  <div class="container py-3">
    <h2 class="mb-3">My Diary Feed</h2>
    <div id="status" class="text-muted mb-2"></div>
    <div class="allPosts" id="allPosts"></div>
  </div>

  <script
    src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js"
    integrity="sha384-RuyvpeZCxMJCqVUGFI0Do1mQrods/hhxYlcVfGPOfQtPJh0JCw12tUAZ/Mv10S7D"
    crossorigin="anonymous"
  ></script>

  <script>
    const API_BASE = "http://localhost:3000";

    function el(tag, className, text) {
      const e = document.createElement(tag);
      if (className) e.className = className;
      if (text !== undefined && text !== null) e.textContent = text;
      return e;
    }

    async function loadPosts() {
      const userID = localStorage.getItem("userID");
      const statusEl = document.getElementById("status");
      const listEl = document.getElementById("allPosts");

      if (!userID) {
        statusEl.textContent = "Please log in again. No user id found.";
        return;
      }

      statusEl.textContent = "Loading your posts...";
      listEl.innerHTML = "";

      try {
        const resp = await fetch(`${API_BASE}/getMyPosts?userID=${encodeURIComponent(userID)}`);
        let data;
        try { data = await resp.json(); } catch { data = null; }

        if (!resp.ok) {
          statusEl.textContent = `Failed to load posts (${resp.status}).`;
          return;
        }
        if (!Array.isArray(data) || data.length === 0) {
          statusEl.textContent = "No posts yet—create one!";
          return;
        }

        statusEl.textContent = "";

        data.forEach((p) => {
          const card = el("div", "Post card p-3 mb-3 shadow-sm");
          card.dataset.postId = p.ID; // store id for easy removal later

          const h = el("h4", "mb-2", p.postTitle || "(Untitled)");
          const meta = el("div", "text-muted mb-2", ""); // no createdAt
          const body = el("p", "mb-3", p.postDescription || "");

          const actions = el("div", "d-flex gap-2");
          const view = el("a", "btn viewPostButton text-white", "View Post");
          view.href = `/Frontend/DedicatedPage.html?id=${encodeURIComponent(p.ID)}`;

          const del = el("button", "btn btn-outline-danger", "Delete");
          del.addEventListener("click", () => onDelete(p.ID, card));

          actions.append(view, del);
          card.append(h, meta, body, actions);
          listEl.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Network error while loading posts. Is the API running?";
      }
    }

    async function onDelete(postId, cardEl) {
      const userID = localStorage.getItem("userID");
      if (!userID) {
        alert("Please log in again.");
        return;
      }

      const ok = confirm("Delete this post? This action cannot be undone.");
      if (!ok) return;

      try {
        const url = `${API_BASE}/post/${encodeURIComponent(postId)}?userID=${encodeURIComponent(userID)}`;
        const resp = await fetch(url, { method: "DELETE" });
        const text = await resp.text();
        if (!resp.ok) {
          alert(`Failed to delete (${resp.status}): ${text}`);
          return;
        }
        // Optimistic UI: remove from DOM
        cardEl.remove();
        // If list becomes empty, show hint
        const listEl = document.getElementById("allPosts");
        if (listEl.children.length === 0) {
          document.getElementById("status").textContent = "No posts yet—create one!";
        }
      } catch (e) {
        console.error(e);
        alert("Network error while deleting the post.");
      }
    }

    document.getElementById("logoutBtn")?.addEventListener("click", () => {
      localStorage.removeItem("userID");
    });

    document.addEventListener("DOMContentLoaded", loadPosts);
  </script>
</body>
</html>
